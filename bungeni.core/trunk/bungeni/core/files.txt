
Files
-----

We store files in a subversion repository. A IVersionedFileUtility allows fetching files for a given
object.


First some setup code..

  >>> from bungeni.core import domain, interfaces
  >>> from zope.component import getMultiAdapter
  >>> from ore.alchemist import Session
  >>> from datetime import datetime, date
  >>> from cStringIO import StringIO 
  >>> import transaction

To demonstrate let's create some groups and a content object which we'll attach files to.
  >>> session = Session()
  >>> parliament = domain.Parliament( short_name=u"p_1", start_date=datetime.now(), election_date=datetime.now())
  >>> session.save( parliament )
  >>> country = domain.Country()
  >>> country.country_id = 'KE'
  >>> country.country_name = u"Kenya"
  >>> session.save(country)
  >>> session.flush() 
  >>> mp_1 = domain.ParliamentMember(u"mp_1", 
  ...        first_name=u"a", 
  ...        last_name=u'ab', 
  ...        birth_country="KE",
  ...        email=u"mp1@example.com", 
  ...        date_of_birth=datetime.now(),
  ...        gender='M') 
 >>> session.save(mp_1)   
  >>> billtype = domain.BillType()
  >>> billtype.bill_type_id = 1 
  >>> billtype.bill_type_name="private"
  >>> session.save(billtype)  
  >>> session.flush()
  >>> bill = domain.Bill( title=u"terra")
  >>> bill.bill_type_id = 1
  >>> bill.owner_id = mp_1.user_id
  >>> bill2 = domain.Bill( title=u"firma")
  >>> bill2.bill_type_id = 1  
  >>> bill2.owner_id = mp_1.user_id  
  >>> committee = domain.Committee(short_name=u"Committee", start_date=datetime.now())
  >>> committee.parliament_id = parliament.parliament_id
  >>> committee2 = domain.Committee(short_name=u"Committee 2", start_date=datetime.now())
  >>> committee2.parliament_id = parliament.parliament_id  
  >>> stored = map( Session().save, ( bill, bill2, committee, committee2 ) )
  >>> transaction.commit()
  >>> today = date.today()

Now we can store attachements on some content

  >>> files = interfaces.IDirectoryLocation( bill ).directory
  >>> files
  <bungeni.core.files.ContainedDirectory object at ...>
  
For testing purposes, we'll commit the changes to the repository now, so we can 
demonstrate the transaction integration next.

  >>> transaction.commit()
  
Let's add a simple attachment file.

  >>> file = files.makeFile('rabbit.txt')
  >>> stream = StringIO("Hello World")
  >>> file.writeStream( stream )
  >>> file.svn_path == "/bill/%s-%s/%s/rabbit.txt"%( today.year, today.month, today.day )
  True
  
  >>> files.keys()
  ['rabbit.txt']  
  
All changes are integrated with the zope transaction system, if we abort the transaction, our modifications are aborted.

  >>> transaction.abort()
  >>> files.keys()
  []
  
Let's add a simple attachment file.

  >>> file = files.makeFile('rabbit.txt')
  >>> stream = StringIO("Hello World")
  >>> file.writeStream( stream )
  >>> file.svn_path == "/bill/%s-%s/%s/rabbit.txt"%( today.year, today.month, today.day )
  True
  
  >>> files.keys()
  ['rabbit.txt']  
  
All changes are integrated with the zope transaction system, if we commit the transaction, our modifications are comitted.

  >>> transaction.commit()
  >>> files.keys()
  ['rabbit.txt']    
  

  
The api (readme.txt) for ore.svn is recommended reading on working with versioned files/directories
