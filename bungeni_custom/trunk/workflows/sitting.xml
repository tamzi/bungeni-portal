<?xml version="1.0"?>
<workflow title="Group sitting workflow"
    description="Workflow for a group sitting."
    tags="draft private public agendaprivate workspace published publishedminutes"
    permission_actions=".View .Edit .Add .Delete"
    >
    
    <!-- features -->
    <feature name="audit" enabled="false" />
    <feature name="version" enabled="false" />
    <feature name="attachment" enabled="false" />
    
    <!-- global grants -->
    <allow permission=".View" roles="Clerk" />
    <allow permission=".Add" roles="Clerk" />
    <allow permission="sittingschedule.View" roles="Clerk" />
    <allow permission="sittingattendance.Edit" roles="Clerk" />
    <allow permission="sittingattendance.Add" roles="Clerk" />
    <allow permission="sittingattendance.Delete" roles="Clerk" />
    
    
    <state id="sitting" title="Sitting" tags="draft public agendaprivate">
        <allow permission=".View" roles="Speaker Owner Signatory MP Minister Anonymous" />
        <allow permission=".Edit" roles="Clerk" />
        <allow permission=".Delete" roles="Clerk" />
        <deny permission="sittingschedule.View" roles="Speaker Owner Signatory MP Minister Anonymous" />
        <deny permission="sittingschedule.Edit" roles="Clerk" />
        <deny permission="sittingschedule.item.Add" roles="Clerk" />
        <deny permission="sittingschedule.item.Delete" roles="Clerk" />
        <allow permission="sittingschedule.itemdiscussion.View" roles="Clerk" />
        <deny permission="sittingschedule.itemdiscussion.View" roles="Speaker Owner Signatory MP Minister Anonymous" />
        <deny permission="sittingschedule.itemdiscussion.Edit" roles="Clerk" />
    </state>
    
    <state id="draft_agenda" title="Draft Agenda" 
        like_state="sitting"
        tags="draft public workspace agendaprivate">
        <allow permission="sittingschedule.Edit" roles="Clerk" />
        <allow permission="sittingschedule.View" roles="Speaker" />
        <allow permission="sittingschedule.item.Add" roles="Clerk" />
        <allow permission="sittingschedule.item.Delete" roles="Clerk" />
        <allow permission="sittingschedule.itemdiscussion.View" roles="Speaker" />
    </state>
    
    <state id="published_agenda" title="Published Agenda" 
        like_state="draft_agenda"
        tags="public published workspace">
        <!-- sitting -->
        <deny permission=".Edit" roles="Clerk" />
        <deny permission=".Delete" roles="Clerk" />
        <allow permission="sittingschedule.View" roles="Speaker Owner Signatory MP Minister Anonymous" />
        <deny permission="sittingschedule.Edit" roles="Clerk" />
    </state>
    
    <state id="published_agenda_internal" title="Published Agenda Internal" 
        like_state="published_agenda"
        tags="public agendaprivate workspace">
        <deny permission="sittingschedule.View" roles="Anonymous" />
    </state>
    
    <state id="draft_minutes" title="Draft Minutes" 
        like_state="published_agenda"
        tags="draft public workspace">
        <allow permission=".Edit" roles="Clerk" />
        <allow permission="sittingschedule.Edit" roles="Clerk" />
        <allow permission="sittingschedule.itemdiscussion.Edit" roles="Clerk" />
    </state>
    
    <state id="published_minutes" title="Published Minutes" 
        like_state="published_agenda"
        tags="public published publishedminutes">
        <deny permission="sittingschedule.item.Add" roles="Clerk" />
        <deny permission="sittingschedule.item.Delete" roles="Clerk" />
        <allow permission="sittingschedule.itemdiscussion.View" roles="Speaker Owner Signatory MP Minister Anonymous" />
        <deny permission="sittingschedule.itemdiscussion.Edit" roles="Clerk" />
    </state>
    
    <state id="published_minutes_internal" title="Published Minutes Internal" 
        like_state="published_minutes"
        tags="public">
        <deny permission="sittingschedule.itemdiscussion.View" roles="Anonymous" />
    </state>
    
    <state id="archived" title="Archive" tags="private" like_state="sitting">
        <deny permission=".View" roles="Owner Signatory MP Minister Anonymous" />
        <deny permission=".Edit" roles="Clerk" />
        <deny permission=".Delete" roles="Clerk" />    
    </state>
    
    <transition title="Create Sitting"
        source=""
        destination="sitting"
        condition=""
        trigger="automatic"
    />
    
    <transition title="Draft Agenda"
        source="sitting"
        destination="draft_agenda"
        condition=""
        trigger="manual"
        roles="Clerk Speaker"
    />
    
    <transition title="Finalize Agenda"
        source="draft_agenda published_agenda_internal"
        destination="published_agenda"
        condition="has_agenda"
        trigger="manual"
        roles="Clerk Speaker"
        require_confirmation="false"
    />

    <transition title="Publish Internal Agenda"
        source="draft_agenda published_agenda"
        destination="published_agenda_internal"
        condition="has_agenda"
        trigger="manual"
        roles="Clerk Speaker"
        require_confirmation="false"
    />

    <transition title="Redraft Agenda"
        source="published_agenda published_agenda_internal"
        destination="draft_agenda"
        condition=""
        trigger="manual"
        roles="Clerk Speaker"
        require_confirmation="true"
    />
    
    <transition title="Draft Minutes"
        source="published_agenda published_agenda_internal"
        destination="draft_minutes"
        condition=""
        trigger="manual"
        roles="Clerk Speaker"
        require_confirmation="false"
    />
    
    <transition title="Publish Minutes"
        source="draft_minutes published_minutes_internal"
        destination="published_minutes"
        condition="agenda_finalized"
        trigger="manual"
        roles="Clerk Speaker"
        require_confirmation="false"
    />

    <transition title="Publish Minutes Internal"
        source="draft_minutes published_minutes"
        destination="published_minutes_internal"
        condition="agenda_finalized"
        trigger="manual"
        roles="Clerk Speaker"
        require_confirmation="false"
    />
    
    <transition title="Redraft Minutes"
        source="published_minutes published_minutes_internal"
        destination="draft_minutes"
        condition=""
        trigger="manual"
        roles="Clerk Speaker"
        require_confirmation="true"
    />
    <transition title="Auto Archive"
        source="sitting"
        destination="archived"
        condition="sitting_dummy"
        trigger="automatic"
    />
</workflow>

