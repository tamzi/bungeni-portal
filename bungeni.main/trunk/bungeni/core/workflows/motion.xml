<?xml version="1.0"?>
<workflow id="motion_workflow" 
    title="Motion Workflow" 
    description="A Motion" 
    domain="bungeni.ui"
    initial_state="">
    
    <!-- Workflow XML Source Style Guide
    
    States
    
    - permissions are organized by target type, with each set of assignments
      for a target type being indicated within a comment to marke the start 
      of each such section.
    
    - within each target-section, the order of appearance of permission actions 
      (for appropriate actions) is:
        View
        Edit
        Add
        Delete
    
    - for each single permission, the order of assigment to each appropriate 
      role follows the following order:
        <role id="bungeni.Clerk" title="Clerks Office" />
        <role id="bungeni.Speaker" title="Speaker Office" />
        <role id="bungeni.Owner" title="Owner" />
        <role id="bungeni.MP" title="Member of parliament" />
        <role id="bungeni.Minister" title="Minister" />
        <role id="bungeni.Everybody" title="All authenticated users" />
        <role id="bungeni.Anybody" title="Bungeni Visitor" />
    
    - for a motion, the MP is also the Owner.
    
    - denying zope.View on a Role seems to deny every other permission !+??
    
    - the root element id should not contain "-" (use "_" as separator).
    
    NOTE: to easily see the the evaluated result of all permission assigments 
    for each workflow state definition (that uses like_state) set the 
    logging level to DEBUG.
    
    !+ <state ... manual_date="true">
        transition to a "politicocratic" destination states need to allow 
        freedom to manually set the transition date_active, but transition 
        to a "bureaucratic" destination states should not.
    -->
    
    <state id="working_draft" title="Working Draft">
        <!-- motion -->
        <grant permission="zope.View" role="bungeni.Clerk" />
        <grant permission="zope.View" role="bungeni.Speaker" />
        <deny permission="zope.View" role="bungeni.Owner" />
        <deny permission="zope.View" role="bungeni.MP" />
        <deny permission="zope.View" role="bungeni.Minister" />
        <deny permission="zope.View" role="bungeni.Everybody" />
        <deny permission="zope.View" role="bungeni.Anybody" />
        <grant permission="bungeni.motion.Edit" role="bungeni.Clerk" />
        <grant permission="bungeni.motion.Edit" role="bungeni.Speaker" />
        <deny permission="bungeni.motion.Edit" role="bungeni.Owner" />
        <deny permission="bungeni.motion.Edit" role="bungeni.MP" />
        <deny permission="bungeni.motion.Edit" role="bungeni.Minister" />
        <deny permission="bungeni.motion.Edit" role="bungeni.Everybody" />
        <deny permission="bungeni.motion.Edit" role="bungeni.Anybody" />
        <grant permission="bungeni.motion.Delete" role="bungeni.Clerk" />
        <grant permission="bungeni.motion.Delete" role="bungeni.Speaker" />
        <deny permission="bungeni.motion.Delete" role="bungeni.Owner" />
        <deny permission="bungeni.motion.Delete" role="bungeni.MP" />
        <deny permission="bungeni.motion.Delete" role="bungeni.Minister" />
        <deny permission="bungeni.motion.Delete" role="bungeni.Everybody" />
        <deny permission="bungeni.motion.Delete" role="bungeni.Anybody" />
        <!-- cosignatory -->
        <grant permission="bungeni.cosignatory.Add" role="bungeni.Clerk" />
        <grant permission="bungeni.cosignatory.Add" role="bungeni.Speaker" />
        <deny permission="bungeni.cosignatory.Add" role="bungeni.Owner" />
        <deny permission="bungeni.cosignatory.Add" role="bungeni.MP" />
        <deny permission="bungeni.cosignatory.Add" role="bungeni.Minister" />
        <deny permission="bungeni.cosignatory.Add" role="bungeni.Everybody" />
        <deny permission="bungeni.cosignatory.Add" role="bungeni.Anybody" />
        <grant permission="bungeni.cosignatory.Delete" role="bungeni.Clerk" />
        <grant permission="bungeni.cosignatory.Delete" role="bungeni.Speaker" />
        <deny permission="bungeni.cosignatory.Delete" role="bungeni.Owner" />
        <deny permission="bungeni.cosignatory.Delete" role="bungeni.MP" />
        <deny permission="bungeni.cosignatory.Delete" role="bungeni.Minister" />
        <deny permission="bungeni.cosignatory.Delete" role="bungeni.Everybody" />
        <deny permission="bungeni.cosignatory.Delete" role="bungeni.Anybody" />
        <!-- fileattachment -->
        <grant permission="bungeni.fileattachment.Edit" role="bungeni.Clerk" />
        <grant permission="bungeni.fileattachment.Edit" role="bungeni.Speaker" />
        <deny permission="bungeni.fileattachment.Edit" role="bungeni.Owner" />
        <deny permission="bungeni.fileattachment.Edit" role="bungeni.MP" />
        <deny permission="bungeni.fileattachment.Edit" role="bungeni.Minister" />
        <deny permission="bungeni.fileattachment.Edit" role="bungeni.Everybody" />
        <deny permission="bungeni.fileattachment.Edit" role="bungeni.Anybody" />
        <grant permission="bungeni.fileattachment.Add" role="bungeni.Clerk" />
        <grant permission="bungeni.fileattachment.Add" role="bungeni.Speaker" />
        <deny permission="bungeni.fileattachment.Add" role="bungeni.Owner" />
        <deny permission="bungeni.fileattachment.Add" role="bungeni.MP" />
        <deny permission="bungeni.fileattachment.Add" role="bungeni.Minister" />
        <deny permission="bungeni.fileattachment.Add" role="bungeni.Everybody" />
        <deny permission="bungeni.fileattachment.Add" role="bungeni.Anybody" />
    </state>
    
    <state id="draft" like_state="working_draft" title="Draft">
        <!-- motion -->
        <deny permission="zope.View" role="bungeni.Clerk" />
        <deny permission="zope.View" role="bungeni.Speaker" />
        <grant permission="zope.View" role="bungeni.Owner" />
        <deny permission="bungeni.motion.Edit" role="bungeni.Clerk" />
        <deny permission="bungeni.motion.Edit" role="bungeni.Speaker" />
        <grant permission="bungeni.motion.Edit" role="bungeni.Owner" />
        <deny permission="bungeni.motion.Delete" role="bungeni.Clerk" />
        <deny permission="bungeni.motion.Delete" role="bungeni.Speaker" />
        <grant permission="bungeni.motion.Delete" role="bungeni.Owner" />
        <!-- cosignatory -->
        <deny permission="bungeni.cosignatory.Add" role="bungeni.Clerk" />
        <deny permission="bungeni.cosignatory.Add" role="bungeni.Speaker" />
        <grant permission="bungeni.cosignatory.Add" role="bungeni.Owner" />
        <deny permission="bungeni.cosignatory.Delete" role="bungeni.Clerk" />
        <deny permission="bungeni.cosignatory.Delete" role="bungeni.Speaker" />
        <grant permission="bungeni.cosignatory.Delete" role="bungeni.Owner" />
        <!-- fileattachment -->
        <deny permission="bungeni.fileattachment.Edit" role="bungeni.Clerk" />
        <deny permission="bungeni.fileattachment.Edit" role="bungeni.Speaker" />
        <grant permission="bungeni.fileattachment.Edit" role="bungeni.Owner" />
        <deny permission="bungeni.fileattachment.Add" role="bungeni.Clerk" />
        <deny permission="bungeni.fileattachment.Add" role="bungeni.Speaker" />
        <grant permission="bungeni.fileattachment.Add" role="bungeni.Owner" />
    </state>
    
    <state id="submitted" like_state="draft" title="Submitted">
        <!-- motion -->
        <grant permission="zope.View" role="bungeni.Clerk" />
        <grant permission="zope.View" role="bungeni.Speaker" />
        <deny permission="bungeni.motion.Edit" role="bungeni.Owner" />
        <deny permission="bungeni.motion.Delete" role="bungeni.Owner" />
        <!-- cosignatory -->
        <deny permission="bungeni.cosignatory.Add" role="bungeni.Owner" />
        <deny permission="bungeni.cosignatory.Delete" role="bungeni.Owner" />
        <!-- fileattachment -->
        <deny permission="bungeni.fileattachment.Edit" role="bungeni.Owner" />
        <deny permission="bungeni.fileattachment.Add" role="bungeni.Owner" />
    </state>
    
    <state id="received" like_state="submitted"
        title="Received by Clerks Office">
        <!-- motion -->
        <grant permission="bungeni.motion.Edit" role="bungeni.Clerk" />
        <!-- cosignatory -->
        <grant permission="bungeni.cosignatory.Add" role="bungeni.Clerk" />
        <grant permission="bungeni.cosignatory.Delete" role="bungeni.Clerk" />
        <!-- fileattachment -->
        <grant permission="bungeni.fileattachment.Edit" role="bungeni.Clerk" />        
        <grant permission="bungeni.fileattachment.Add" role="bungeni.Clerk" />
    </state>
    
    <state id="clarification_required" like_state="submitted"
        title="Needs Clarification by MP">
        <!-- motion -->
        <grant permission="bungeni.motion.Edit" role="bungeni.Owner" />
        <!-- cosignatory -->
        <grant permission="bungeni.cosignatory.Add" role="bungeni.Owner" />
        <grant permission="bungeni.cosignatory.Delete" role="bungeni.Owner" />
        <!-- fileattachment -->
        <grant permission="bungeni.fileattachment.Edit" role="bungeni.Owner" />
        <grant permission="bungeni.fileattachment.Add" role="bungeni.Owner" />
    </state>
    
    <!-- Here the "concept" is that the PI is *formally admissible* and so 
    ready to be considered by the "speaker's office" for the rules/political 
    admissibility. 
    -->
    <state id="completed" like_state="submitted"
        title="Submitted to the Speaker">
        <!-- motion -->
        <grant permission="bungeni.motion.Edit" role="bungeni.Speaker" />
        <!-- cosignatory -->
        <grant permission="bungeni.cosignatory.Add" role="bungeni.Speaker" />
        <grant permission="bungeni.cosignatory.Delete" role="bungeni.Speaker" />
        <!-- fileattachment -->
        <grant permission="bungeni.fileattachment.Edit" role="bungeni.Speaker" />
        <grant permission="bungeni.fileattachment.Add" role="bungeni.Speaker" />
    </state>
    
    <state id="incomplete" like_state="received"
        title="Needs Clarification by Clerks Office" />
    
    <state id="withdrawn" like_state="submitted" title="Withdrawn" />
    
    <state id="inadmissible" like_state="submitted" title="Inadmissible" />
    
    <state id="admissible" like_state="submitted" title="Admissible">
        <!-- motion -->
        <grant permission="zope.View" role="bungeni.MP" />
        <grant permission="zope.View" role="bungeni.Minister" />
        <grant permission="zope.View" role="bungeni.Everybody" />
        <grant permission="zope.View" role="bungeni.Anybody" />
    </state>
    
    <state id="schedule_pending" like_state="admissible" 
        title="Schedule pending" />
    
    <state id="scheduled" like_state="admissible" title="Scheduled" />
    
    <state id="adopted" like_state="admissible" title="Adopted" />
    
    <state id="adopted_amendments" like_state="admissible"
        title="Adopted with amendments" />
    
    <!-- a motion was debated and the debate adjourned  -->
    <state id="adjourned" like_state="admissible" title="Debate adjourned" />
    
    <!-- admissable motion that cannot be debated -->
    <state id="deferred" like_state="admissible" title="Deferred" />
    
    <!-- defered motion that was not debated -->
    <state id="elapsed" like_state="admissible" title="Elapsed" />
    
    <!-- motion was scheduled for but droped, becuase no show of MP etc -->
    <state id="dropped" like_state="admissible" title="Dropped" />
    
    <state id="rejected" like_state="admissible" title="Rejected"/>
    
    <state id="withdrawn_public" like_state="admissible" 
        title="Withdrawn" />
    
    
    <!--
    
    Transitions
    
    - the order of attributes should respect:
        id 
        title
        source
        destination
        condition=NullCondition
        trigger=MANUAL
        roles=bungeni.Clerk
        permission=CheckerPublic !+ bungeni.{module}.wf.{transition_id}
        order=0
        event=None
        require_confirmation=False
    
    -->
    
    <transition id="create"
        title="Create Motion"
        source=""
        destination="draft"
        condition=".utils.conditions.user_is_context_owner"
        trigger="automatic"
    />
    
    <transition id="create_on_behalf_of"
        title="Create Motion (On behalf of)"
        source=""
        destination="working_draft"
        condition=".utils.conditions.user_is_not_context_owner"
        trigger="automatic"
    />
    
    <transition id="submit"
        title="Submit to Clerk"
        source="working_draft draft"
        destination="submitted"
        condition=""
        trigger="manual"
        roles="bungeni.Owner"
        event=".interfaces.IMotionSubmittedEvent"
    />
    
    <transition id="receive" 
        title="Receive" 
        source="submitted"
        destination="received" 
        condition=""
        trigger="manual" 
        roles="bungeni.Clerk"
        event=".interfaces.IMotionReceivedEvent"
    />
    
    <transition id="require_clarification"
        title="Needs Clarification to Complete"
        source="received" 
        destination="clarification_required"
        condition=""
        trigger="manual"
        roles="bungeni.Clerk"
        event=".interfaces.IMotionClarifyEvent" 
        require_confirmation="true"
    />
    
    <transition id="complete" 
        title="Submit to the Speaker Office"
        source="received" 
        destination="completed" 
        condition=""
        trigger="manual"
        roles="bungeni.Clerk"
    />
    
    <transition id="approve"
        title="Approve" 
        source="completed"
        destination="admissible" 
        condition=""
        trigger="manual"
        roles="bungeni.Speaker"
    />
    
    <transition id="disapprove"
        title="Disapprove"
        source="completed"
        destination="inadmissible"
        condition=""
        trigger="manual"
        roles="bungeni.Speaker"
        event=".interfaces.IMotionRejectedEvent"
        require_confirmation="true"
    />
    
    <transition id="allow_schedule"
        title="Make available for scheduling" 
        source="admissible deferred adjourned"
        destination="schedule_pending"
        trigger="manual"
        roles="bungeni.Speaker"
        event=".interfaces.IMotionPendingEvent"
    />
    
    <transition id="require_recomplete"
        title="Needs Clarification to Approve"
        source="completed" 
        destination="incomplete" 
        condition=""
        trigger="manual"
        roles="bungeni.Speaker"
        require_confirmation="true"
    />
    
    <transition id="recomplete"
        title="Re-complete"
        source="incomplete"
        destination="completed"
        condition=""
        trigger="manual"
        roles="bungeni.Clerk"
    />
    
    <transition id="require_recomplete_clarification" 
        title="Needs Clarification to Complete"
        source="incomplete"
        destination="clarification_required"
        condition=""
        trigger="manual"
        roles="bungeni.Clerk"
        event=".interfaces.IMotionClarifyEvent"
        require_confirmation="true"
    />
    
    <transition id="resubmit"
        title="Resubmit to Clerk"
        source="clarification_required"
        destination="submitted"
        condition=""
        trigger="manual"
        roles="bungeni.Owner"
    />
    
    <transition id="defer"
        title="Defer"
        source="admissible"
        destination="deferred"
        condition=""
        trigger="manual"
        roles="bungeni.Speaker"
        event=".interfaces.IMotionDeferredEvent"
    />
    
    <transition id="elapse"
        title="Elapse"
        source="deferred"
        destination="elapsed"
        condition=""
        trigger="manual"
        roles="bungeni.Speaker"
        require_confirmation="true"
    />
    
    <transition id="schedule"
        title="Schedule"
        source="schedule_pending"
        destination="scheduled" 
        condition=".motion.conditions.is_scheduled"
        trigger="system" 
        roles="bungeni.Clerk"
        event=".interfaces.IMotionScheduledEvent"
    />
    
    <transition id="reschedule" 
        title="Re-schedule" 
        source="scheduled"
        destination="schedule_pending"
        condition=""
        trigger="system"
        roles="bungeni.Clerk"
    />
    
    <transition id="revert_to_admissible" 
        title="Revert to admissible" 
        source="schedule_pending"
        destination="admissible"
        condition=""
        trigger="manual"
        roles="bungeni.Speaker"
    />
    
    <transition id="drop" 
        title="Drop" 
        source="scheduled"
        destination="dropped"
        condition=""
        trigger="manual"
        roles="bungeni.Clerk"
        event=".interfaces.IMotionDroppedEvent"
    />
    
    <transition id="adjourn"
        title="Adjourn debate"
        source="scheduled"
        destination="adjourned"
        condition=""
        trigger="manual"
        roles="bungeni.Clerk"
        event=""
    />
    
    <transition id="adopt"
        title="Adopt"
        source="scheduled" 
        destination="adopted"
        condition=""
        trigger="manual"
        roles="bungeni.Clerk"
        event=".interfaces.IMotionAdoptedEvent"
        require_confirmation="true"
    />
    
    <transition id="adopt_amendments"
        title="Adopt with amendments"
        source="scheduled"
        destination="adopted_amendments"
        condition=""
        trigger="manual"
        roles="bungeni.Clerk"
        event=".interfaces.IMotionAdoptedEvent"
        require_confirmation="true"
    />
    
    <transition id="reject"
        title="Reject a scheduled motion"
        source="scheduled"
        destination="rejected"
        condition=""
        trigger="manual"
        roles="bungeni.Speaker"
        event=".interfaces.IMotionRejectedEvent"
        require_confirmation="true"
    />
    
    <transition id="withdraw" 
        title="Withdraw" 
        source="submitted received completed clarification_required"
        destination="withdrawn" 
        condition=""
        trigger="manual"
        roles="bungeni.Clerk bungeni.Owner"
        require_confirmation="true" 
    />
    
    <transition id="withdraw_public" 
        title="Withdraw"
        source="admissible scheduled deferred adjourned schedule_pending"
        destination="withdrawn_public"
        condition=""
        trigger="manual"
        roles="bungeni.Clerk bungeni.Owner"
        require_confirmation="true"
    />

</workflow>
